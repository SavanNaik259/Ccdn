<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Bandwidth Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .log { background: #f5f5f5; border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; border-color: #f44336; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        button { padding: 10px 20px; margin: 5px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .product { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
        .product img { width: 100%; height: 150px; object-fit: cover; }
    </style>
</head>
<body>
    <h1>üîß Bandwidth Test Debug Tool</h1>
    
    <div>
        <button onclick="testStep1()">Step 1: Test Netlify Function</button>
        <button onclick="testStep2()">Step 2: Test CDN Direct</button>
        <button onclick="testStep3()">Step 3: Full Integration Test</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>
    <div id="products" class="products"></div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${timestamp}] ${message}`;
            logs.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('products').innerHTML = '';
        }

        async function testStep1() {
            log('üîÑ Testing Netlify function...');
            try {
                const response = await fetch('/.netlify/functions/load-bandwidth-test-products?category=bandwidth-test-1');
                log(`‚úÖ Function response status: ${response.status}`, 'success');
                
                const text = await response.text();
                log(`üìä Response size: ${text.length} characters`);
                
                const data = JSON.parse(text);
                log(`üìã Response data: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.downloadURL) {
                    log(`üîó Download URL received: ${data.downloadURL.substring(0, 100)}...`, 'success');
                } else {
                    log(`‚ùå No download URL in response`, 'error');
                }
            } catch (error) {
                log(`‚ùå Function test failed: ${error.message}`, 'error');
                log(`‚ùå Error stack: ${error.stack}`, 'error');
            }
        }

        async function testStep2() {
            log('üîÑ Getting download URL first...');
            try {
                const response = await fetch('/.netlify/functions/load-bandwidth-test-products?category=bandwidth-test-1');
                const data = await response.json();
                
                if (!data.success || !data.downloadURL) {
                    log(`‚ùå No download URL available`, 'error');
                    return;
                }

                log(`üîó Testing direct CDN access: ${data.downloadURL.substring(0, 100)}...`);
                
                const cdnResponse = await fetch(data.downloadURL);
                log(`‚úÖ CDN response status: ${cdnResponse.status}`, 'success');
                
                const cdnText = await cdnResponse.text();
                log(`üìä CDN response size: ${cdnText.length} characters`);
                
                const products = JSON.parse(cdnText);
                log(`‚úÖ Parsed ${products.length} products`, 'success');
                
                // Show first product details
                if (products.length > 0) {
                    log(`üìã First product: ${JSON.stringify(products[0], null, 2)}`);
                }
                
            } catch (error) {
                log(`‚ùå CDN test failed: ${error.message}`, 'error');
                log(`‚ùå Error stack: ${error.stack}`, 'error');
            }
        }

        async function testStep3() {
            log('üîÑ Running full integration test...');
            try {
                // Step 1: Get function response
                const response = await fetch('/.netlify/functions/load-bandwidth-test-products?category=bandwidth-test-1');
                const data = await response.json();
                
                if (!data.success || !data.downloadURL) {
                    log(`‚ùå Function failed: ${data.error || 'No download URL'}`, 'error');
                    return;
                }

                log(`‚úÖ Function success: ${data.message}`, 'success');

                // Step 2: Fetch from CDN
                const cdnResponse = await fetch(data.downloadURL);
                const products = await cdnResponse.json();
                
                log(`‚úÖ CDN success: Loaded ${products.length} products`, 'success');

                // Step 3: Display products
                displayProducts(products);
                
            } catch (error) {
                log(`‚ùå Integration test failed: ${error.message}`, 'error');
                log(`‚ùå Error details: ${error.stack}`, 'error');
            }
        }

        function displayProducts(products) {
            const productsDiv = document.getElementById('products');
            
            if (!Array.isArray(products) || products.length === 0) {
                productsDiv.innerHTML = '<div>No products to display</div>';
                return;
            }
            
            const productCards = products.map(product => `
                <div class="product">
                    <img src="${product.image}" alt="${product.name}" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5JbWFnZTwvdGV4dD48L3N2Zz4='">
                    <h4>${product.name}</h4>
                    <p>‚Çπ${product.price}</p>
                    <p>${product.description}</p>
                </div>
            `).join('');

            productsDiv.innerHTML = productCards;
            log(`‚úÖ Displayed ${products.length} products`, 'success');
        }

        // Auto-test when page loads
        setTimeout(() => {
            log('üöÄ Auto-running integration test...');
            testStep3();
        }, 1000);
    </script>
</body>
</html>