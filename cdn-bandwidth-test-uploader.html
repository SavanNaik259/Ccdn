
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Bandwidth Test - Product Uploader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .secondary-btn {
            background: #6c757d;
        }
        .secondary-btn:hover { background: #545b62; }
        .message {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .progress {
            background: #f0f0f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .test-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• CDN Bandwidth Test - Product Uploader</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> This test must be run on your deployed Netlify site to work properly. Local testing will not show CDN behavior.
        </div>

        <div class="test-info">
            <h3>üéØ Test Objective:</h3>
            <p><strong>First User:</strong> Downloads from Firebase Storage (bandwidth used)</p>
            <p><strong>Second User:</strong> Downloads from CDN cache (no bandwidth used)</p>
            <p><strong>Monitor:</strong> Firebase Console > Storage > Usage</p>
        </div>

        <form id="productForm">
            <div class="form-group">
                <label for="testCategory">Test Category</label>
                <select id="testCategory" required>
                    <option value="bandwidth-test-1">Bandwidth Test 1</option>
                    <option value="bandwidth-test-2">Bandwidth Test 2</option>
                    <option value="bandwidth-test-3">Bandwidth Test 3</option>
                </select>
            </div>

            <div class="form-group">
                <label for="productName">Product Name</label>
                <input type="text" id="productName" required placeholder="e.g. Diamond Necklace">
            </div>

            <div class="form-group">
                <label for="productPrice">Price (‚Çπ)</label>
                <input type="number" id="productPrice" min="1" required placeholder="e.g. 75000">
            </div>

            <div class="form-group">
                <label for="productDescription">Description</label>
                <textarea id="productDescription" required placeholder="Product description..."></textarea>
            </div>

            <div class="form-group">
                <label for="productImage">Product Image (Choose a large image 200KB+ for better testing)</label>
                <input type="file" id="productImage" accept="image/*" required>
            </div>

            <button type="submit" id="submitBtn">üì§ Upload Product with CDN Headers</button>
        </form>

        <div class="progress" id="uploadProgress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="loading" id="loading">
            <div>‚ö° Uploading with CDN cache headers...</div>
        </div>

        <button class="secondary-btn" onclick="window.open('cdn-bandwidth-test-loader.html', '_blank')">
            üîç Open Product Loader (Test CDN)
        </button>

        <button class="secondary-btn" onclick="clearAllTestData()">
            üóëÔ∏è Clear All Test Data
        </button>

        <div id="messages"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrLCButDevLeILcBjrUCd9e7amXVjW-uI",
            authDomain: "auric-a0c92.firebaseapp.com",
            projectId: "auric-a0c92",
            storageBucket: "auric-a0c92.firebasestorage.app",
            messagingSenderId: "878979958342",
            appId: "1:878979958342:web:e6092f7522488d21eaec47",
            measurementId: "G-ZYZ750JHMB"
        };

        // Initialize Firebase
        let app, storage;
        try {
            app = firebase.initializeApp(firebaseConfig, 'bandwidth-test-uploader');
            storage = app.storage();
            
            app.auth().signInAnonymously().then(() => {
                console.log('‚úÖ Firebase authenticated for CDN testing');
                showMessage('üî• Firebase connected - Ready for CDN testing!', 'success');
            }).catch((error) => {
                console.error('‚ùå Firebase auth failed:', error);
                showMessage(`Authentication failed: ${error.message}`, 'error');
            });
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            showMessage(`Firebase initialization failed: ${error.message}`, 'error');
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            messagesDiv.innerHTML = `<div class="message ${type}">[${timestamp}] ${message}</div>`;
            
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 8000);
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('uploadProgress');
            
            if (percent > 0) {
                progressContainer.style.display = 'block';
                progressBar.style.width = percent + '%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        async function uploadImageWithCDNHeaders(file, productId, category) {
            const fileName = `${category}_${productId}_${Date.now()}.jpg`;
            const storageRef = storage.ref(`bandwidthTest/${fileName}`);

            // Critical: CDN cache headers for 30 days
            const metadata = {
                cacheControl: 'public, max-age=2592000',
                contentType: file.type,
                customMetadata: {
                    testCategory: category,
                    productId: productId,
                    uploadedAt: new Date().toISOString()
                }
            };

            console.log('üì§ Uploading image with CDN headers:', metadata);

            const uploadTask = storageRef.put(file, metadata);

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateProgress(progress);
                        console.log(`Upload progress: ${Math.round(progress)}%`);
                    },
                    (error) => {
                        console.error('‚ùå Upload failed:', error);
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log('‚úÖ Image uploaded successfully:', downloadURL);
                            resolve(downloadURL);
                        } catch (error) {
                            reject(error);
                        }
                    }
                );
            });
        }

        async function saveProductDataWithCDNHeaders(productData, category) {
            console.log('üìù Saving product data for category:', category);
            
            // Load existing products for this category
            let existingProducts = [];
            
            try {
                const storageRef = storage.ref(`bandwidthTest/${category}-products.json`);
                const downloadURL = await storageRef.getDownloadURL();
                const response = await fetch(downloadURL);
                
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        existingProducts = data;
                    }
                }
            } catch (error) {
                console.log('üìÑ Creating new product file for category:', category);
                existingProducts = [];
            }

            // Add new product
            existingProducts.push(productData);

            // Save back with CDN headers
            const jsonData = JSON.stringify(existingProducts, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            
            const storageRef = storage.ref(`bandwidthTest/${category}-products.json`);
            
            // Critical: CDN cache headers for JSON files
            const metadata = {
                contentType: 'application/json',
                cacheControl: 'public, max-age=2592000',
                customMetadata: {
                    testCategory: category,
                    productsCount: existingProducts.length.toString(),
                    lastUpdated: new Date().toISOString()
                }
            };

            console.log('üíæ Saving JSON with CDN headers:', metadata);
            await storageRef.put(blob, metadata);
            
            return existingProducts.length;
        }

        function generateProductId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            return `TEST-${timestamp}-${random}`;
        }

        async function clearAllTestData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL test data. Continue?')) return;
            
            try {
                showMessage('üóëÔ∏è Clearing all test data...', 'info');
                
                const testCategories = ['bandwidth-test-1', 'bandwidth-test-2', 'bandwidth-test-3'];
                
                for (const category of testCategories) {
                    try {
                        // Delete JSON file
                        const jsonRef = storage.ref(`bandwidthTest/${category}-products.json`);
                        await jsonRef.delete();
                        console.log(`‚úÖ Deleted ${category} JSON file`);
                    } catch (error) {
                        console.log(`‚ÑπÔ∏è No JSON file found for ${category}`);
                    }
                }
                
                // List and delete all images in bandwidthTest folder
                try {
                    const folderRef = storage.ref('bandwidthTest/');
                    const listResult = await folderRef.listAll();
                    
                    for (const itemRef of listResult.items) {
                        if (itemRef.name.includes('.jpg') || itemRef.name.includes('.png')) {
                            await itemRef.delete();
                            console.log(`‚úÖ Deleted image: ${itemRef.name}`);
                        }
                    }
                } catch (error) {
                    console.log('‚ÑπÔ∏è No images found to delete');
                }
                
                showMessage('‚úÖ All test data cleared successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error clearing test data:', error);
                showMessage(`Error clearing data: ${error.message}`, 'error');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const form = document.getElementById('productForm');
            
            try {
                submitBtn.disabled = true;
                loading.style.display = 'block';
                
                // Get form data
                const category = document.getElementById('testCategory').value;
                const productName = document.getElementById('productName').value;
                const productPrice = parseFloat(document.getElementById('productPrice').value);
                const productDescription = document.getElementById('productDescription').value;
                const productImage = document.getElementById('productImage').files[0];

                // Validate image size for better testing
                if (productImage.size < 50000) {
                    showMessage('‚ö†Ô∏è Consider using a larger image (50KB+) for better CDN testing', 'info');
                }

                const productId = generateProductId();

                showMessage(`üì§ Uploading ${productName} to category: ${category}`, 'info');

                // Upload image with CDN headers
                const imageUrl = await uploadImageWithCDNHeaders(productImage, productId, category);

                updateProgress(80);

                // Create product data
                const productData = {
                    id: productId,
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    image: imageUrl,
                    category: category,
                    createdAt: new Date().toISOString(),
                    testNote: 'CDN bandwidth test product'
                };

                // Save product data with CDN headers
                const totalProducts = await saveProductDataWithCDNHeaders(productData, category);

                updateProgress(100);

                showMessage(`üéâ Product "${productName}" added successfully! Total products in ${category}: ${totalProducts}. Open the loader to test CDN bandwidth behavior.`, 'success');
                
                // Reset form
                form.reset();
                
                setTimeout(() => {
                    loading.style.display = 'none';
                    updateProgress(0);
                }, 3000);

            } catch (error) {
                console.error('‚ùå Upload failed:', error);
                showMessage(`Upload failed: ${error.message}`, 'error');
                loading.style.display = 'none';
                updateProgress(0);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('üí• Global error:', event.error);
            showMessage(`Unexpected error: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('üí• Promise rejection:', event.reason);
            showMessage(`Promise error: ${event.reason.message || event.reason}`, 'error');
            event.preventDefault();
        });

        // Show deployment warning if on localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                showMessage('‚ö†Ô∏è You are testing locally. CDN behavior will only work on your deployed Netlify site!', 'error');
            }, 2000);
        }
    </script>
</body>
</html>
